# ----모듈

products = {   #allergy 알수없음에 대해서는 알러지 판별로직 필요함, trace는 임의로 값을 넣었음
    "0" : {
        "product_id" : "201905000000", #이걸 key값으로 넣으면 좋을지
        "name" : "설화눈꽃팝김부각스낵",
        "category" : "과자",
        "ingerdients" : ["찹쌀", "김", "참깨", "옥수수기름(옥배유)", "양파", "무", "대파", "천일염", "마늘", "새우", "멸치", "다시마", "건표고버섯", "둥굴레", "감초", "정제수"], # 설화눈꽃팝김부각스낵
        "allergy" : "없음",
        "trace" :  "null"
    },
    "1" : {
        "product_id" : "201804000000",
        "name" : "설화눈꽃팝김부각스낵 아몬드맛",
        "category" : "과자",
        "ingerdients" : ["찹쌀", "김", "참깨", "옥수수기름(옥배유)", "아몬드", "양파", "무", "천일염", "대파", "마늘", "새우", "멸치", "다시마", "건표고버섯", "둥굴레", "감초", "정제수"],
        "allergy" : "아몬드",
        "trace" : ""
    },
    "2" : {
        "product_id" : "201804000000",
        "name" : "고들빼기김치",
        "category" : "김치류",
        "ingerdients" : ["고들빼기", "멸치액", "염장새우", "L-글루타민산나트륨", "양파", "다시마육수", "혼합간장", "고춧가루", "마늘", "생강", "갈색설탕", "참깨", "물엿", "매실청", "배즙", "찹쌀풀", "당근", "파", "파"],
        "allergy" : "새우,대두,밀",
        "trace" : ""
    },
    "3" : {
        "product_id" : "19950400000000",
        "name" : "해태 허니버터칩",
        "category" : "과자",
        "ingerdients" : ["감자(미국산)", "혼합식용유[팜올레인유(말레이시아산)59.98%", "해바라기유(수입산)40%", "토코페롤(혼합형)]", "복합조미식품[허니버터맛시즈닝(결정과당", "백설탕", "정제소금", "탈지분유(우유)", "버터혼합분말65(대두)", "이스트익스트랙트파우다YE3(효모추출물)", "천연향신료(파슬리후레이크)", "아카시아꿀분말(아카시아꿀(국내산))", "고메버터(프랑스산))(밀)]]"],
        "allergy" : "알수없음",
        "trace" :  "null"
    },
    "4" : {
        "product_id" : "20140500000000",
        "name" : "헬로버블 라이스퍼프 양파맛",
        "ingerdients" : ["현미73.55%(유기농,국산)", "어니언시즈닝12.24%{정백당", "결정포도당", "말토덱스트린", "리치버터분말", "양파분7.24%(중국산)", "합성향료(구운양파향)", "L-글루탐산나트륨(향미증진제)}", "백미7.36%(유기농,국산)", "유기이소말토쌀올리고당", "정제수", "옥수수과립", "비타민E혼합제제분말(변성전분)", "유기농설탕"],
        "allergy" : "알수없음",
        "trace" :  "null"
    },
    "5" : {
        "product_id" : "201105000000",
        "name" : "두마리목장 콜비치즈",
        "ingerdients" : ["원유(국산)99.9%", "우유응고효소", "유산균", "식염", "안나토색소(천연색소)"],
        "allergy" : "우유함유",
        "trace" :  "null"
    },
    "6" : {
        "product_id" : "2011050000000",
        "name" : "양반 바삭 튀김가루",
        "ingerdients" : ["밀가루(밀/미국산)", "변성전분", "베이킹파우더(팽창제,산도조절제,전분)", "정제소금(국내산)", "양파분말0.5%(양파100%/중국산)", "옥수수가루", "백후추분말"],
        "allergy" : "밀",
        "trace" :  "null"
    },
    "7" : {
        "product_id" : "2011040000000",
        "name" : "돈목살훈제바베큐스테이크",
        "ingerdients" : ["돼지고기(목살,외국산-국가명www.yellowfarm.co.kr/별도표기)96.68%", "스모크시즈닝-1{복합스파이스AS-1[분리대두단백(중국산),정제소금(국내산)]}", "토마토케찹", "아질산나트륨(발색제)", "파슬리후레이크"],
        "allergy" : "돼지고기,밀,우유,대두,쇠고기,토마토 함유",
        "trace" :  "null"
    },
    "8" : {
        "product_id" : "2011040000000",
        "name" : "태양초 고추장 골드",
        "ingerdients" : ["고춧가루2.84%(국산)", "물엿", "소맥분(밀:미국산,호주산)", "혼합양념(중국산태양초고춧가루6.49%,정제소금,마늘,양파/중국산)", "밀쌀", "분말혼합양념(고춧가루0.99%,밀쌀가루,정제소금,포도당,찹쌀가루,마늘분/중국산)", "정제소금", "정백당", "주정", "종국"],
        "allergy" : "알수없음",
        "trace" :  "null"
    },
    "9" : {
        "product_id" : "2011040000000",
        "name" : "환타지 믹스너트",
        "ingerdients" : ["커피땅콩[(중국)땅콩52%,설탕,커피1.4%,고구마전분]10%", "화이트볼[(중국)설탕55.71%,땅콩42.86%,옥수수전분]10%", "찹쌀땅콩[(중국)/땅콩39.91%,밀가루,설탕,찹쌀가루12.87%,물엿,중탄산암모늄(팽창제),젤라틴(돼지),L-글루타민산나트륨(향미증진제),말토덱스트린]15%", "튀김땅콩[(중국)땅콩95.8%,팜유3.2%,소금]15%", "로스티드피터츠[(베트남)땅콩50%,밀가루,백설탕,코코넛유,코코넛주스]15%", "바나나칩[(필리핀)바나나65.5%,코코넛오일,설탕,천연바나나향]15%", "볶음아몬드[(미국)아몬드100%]10%", "꿀땅콩[(중국)땅콩53.60%,설탕,밀가루,꿀,찰옥수수변성전분(아세틸아디핀산이전분),커피]10%"],
        "allergy" : "알수없음",
        "trace" :  "null"
    }
}

'''
# 테스트용 유저 파이널프로필 (당뇨 + 신장병 환자 가정) #형식1
test_final_profile = {
    "user_id": "user_123",
    "restricted_ingredients": ["우유", "땅콩"],
    "protein": 40.0,
    "sodium": 2300.0,
    "sugar": 5.0
    }
'''

# 테스트용 유저 파이널프로필 (당뇨 + 신장병 환자 가정) #형식2
final_profiles = {
    "0": { # 당뇨 + 우유/땅콩 알러지
        "restricted_ingredients": ["우유", "땅콩"],
        "sugar": 5.0
    },
    "1": { # 고혈압 + 새우 알러지
        "restricted_ingredients": ["새우"],
        "sodium": 2300.0,
        "potassium_min": 3500.0,
        "fat_ratio": 0.25
    },
    "2": { # 투석 전 신장질환 (70kg 기준)
        "restricted_ingredients": [],
        "protein": 42.0,  # 0.6 * 70
        "sodium": 2300.0,
        "phosphorus": 1000.0,
        "calcium": 1000.0,
        "kcal": 2450.0    # 35 * 70
    },
    "3": { # 투석 중 신장질환 + 밀 알러지
        "restricted_ingredients": ["밀"],
        "protein": 84.0,  # 1.2 * 70
        "sodium": 2300.0,
        "potassium": 2000.0,
        "phosphorus": 1000.0,
        "kcal": 2450.0
    },
    "4": { # 당뇨 + 고혈압 복합 (가장 흔한 케이스)
        "restricted_ingredients": [],
        "sugar": 5.0,
        "sodium": 2300.0,
        "potassium_min": 3500.0,
        "fat_ratio": 0.25
    },
    "5": { # 복합 알러지 (유제품, 계란, 견과류)
        "restricted_ingredients": ["우유", "계란", "견과류"],
        "is_allergy_only": True # 수치 제한 없음
    },
    "6": { # 당뇨 + 투석 전 신장질환 + 대두 알러지
        "restricted_ingredients": ["대두"],
        "sugar": 5.0,
        "protein": 42.0,
        "sodium": 2300.0,
        "phosphorus": 1000.0
    },
    "7": { # 고혈압 + 생선/조개류 알러지
        "restricted_ingredients": ["고등어", "조개"],
        "sodium": 2300.0,
        "potassium_min": 3500.0,
        "fat_ratio": 0.25
    },
    "8": { # 모든 질환 복합 (최악의 시나리오 - 고위험군)
        "restricted_ingredients": ["땅콩", "밀"],
        "sugar": 5.0,
        "protein": 42.0,
        "sodium": 2300.0,
        "potassium": 2000.0, # 신장질환 기준 적용
        "phosphorus": 1000.0,
        "fat_ratio": 0.25
    },
    "9": { # 고령자 타겟 (고혈압 + 투석 중 신장질환)
        "restricted_ingredients": [],
        "protein": 84.0,
        "sodium": 2300.0,
        "potassium": 2000.0,
        "phosphorus": 1000.0,
        "fat_ratio": 0.25
    }
}

allergy_substitution_rules = {
    "description": "식약처 고시 22종 알레르기 유발 물질별 대체 식재료 추천 가이드",
    "rules": [
      {
        "category": "난류",
        "items": ["계란", "메추리알", "오리알"],
        "substitutes": ["두부", "병아리콩 거품(아쿠아파바)", "치아씨드 페이스트", "강낭콩"],
        "usage_tip": "베이킹 시 계란의 결합력은 아쿠아파바나 바나나로 대체 가능합니다."
      },
      {
        "category": "우유",
        "items": ["우유", "산양유", "원유", "탈지분유", "환원유", "환원무지방우유", "가공유"],
        "substitutes": ["두유", "아몬드유", "오트유", "쌀음료", "코코넛밀크"],
        "usage_tip": "크리미한 질감을 원할 경우 코코넛밀크나 캐슈넛 밀크가 적합합니다."
      },
      {
        "category": "메밀",
        "items": ["메밀"],
        "substitutes": ["쌀", "밀", "감자 전분", "고구마 전분"],
        "usage_tip": "면 요리 시 쌀면이나 전분 함량이 높은 면으로 쫄깃함을 대체합니다."
      },
      {
        "category": "땅콩",
        "items": ["땅콩"],
        "substitutes": ["해바라기씨", "호박씨", "캐슈넛(견과류 알러지 없을 시)", "병아리콩"],
        "usage_tip": "고소한 맛은 볶은 씨앗류나 콩류로 대체 가능합니다."
      },
      {
        "category": "대두",
        "items": ["대두"],
        "substitutes": ["완두콩", "병아리콩", "코코넛 아미노스(간장 대체)", "퀴노아"],
        "usage_tip": "간장 대신 코코넛 아미노스를 사용하면 대두 없이 감칠맛을 낼 수 있습니다."
      },
      {
        "category": "밀",
        "items": ["밀"],
        "substitutes": ["쌀가루", "귀리가루", "타피오카 가루", "메밀가루(메밀 알러지 없을 시)"],
        "usage_tip": "글루텐 프리 가루 믹스를 사용하여 점성을 조절하세요."
      },
      {
        "category": "잣",
        "items": ["잣"],
        "substitutes": ["해바라기씨", "호박씨", "마카다미아"],
        "usage_tip": "바질 페스토 등 소스 제작 시 씨앗류로 대체 가능합니다."
      },
      {
        "category": "호두",
        "items": ["호두"],
        "substitutes": ["피칸", "호박씨", "볶은 귀리"],
        "usage_tip": "식감과 풍미가 유사한 피칸이 가장 좋은 대안입니다."
      },
      {
        "category": "게/새우",
        "items": ["게", "새우"],
        "substitutes": ["흰살 생선", "버섯(킹오이스터)", "두부"],
        "usage_tip": "탱글한 식감은 버섯이나 어묵(성분 확인 필수)으로 대체합니다."
      },
      {
        "category": "돼지고기/쇠고기/닭고기",
        "items": ["돼지고기", "쇠고기", "닭고기"],
        "substitutes": ["콩고기", "템페", "버섯류", "생선"],
        "usage_tip": "단백질원은 식물성 단백질이나 대체육으로 보충합니다."
      },
      {
        "category": "복숭아/토마토",
        "items": ["복숭아", "토마토"],
        "substitutes": ["사과", "자두(복숭아 대용)", "빨간 파프리카(토마토 대용)"],
        "usage_tip": "토마토 소스의 색감과 산미는 파프리카와 식초 조합으로 흉내 낼 수 있습니다."
      },
      {
        "category": "아황산류",
        "items": ["아황산류(산화방지제)"],
        "substitutes": ["천연 발효 식초", "레몬즙", "생과일"],
        "usage_tip": "가공식품보다는 신선 식품 위주의 선택이 필수적입니다."
      },
      {
        "category": "조개류/굴/전복/홍합",
        "items": ["조개류", "굴", "전복", "홍합"],
        "substitutes": ["다시마", "표고버섯", "멸치(생선 알러지 없을 시)"],
        "usage_tip": "국물 요리의 감칠맛은 해조류와 버섯으로 충분히 낼 수 있습니다."
      },
      {
        "category": "오징어",
        "items": ["오징어"],
        "substitutes": ["문어(연체류 알러지 확인)", "버섯", "곤약"],
        "usage_tip": "쫄깃한 식감은 데친 곤약이나 버섯 기둥으로 대체 가능합니다."
      }
    ]
  }





# --- [프롬프트 생성기 함수] ---

def generate_system_prompt(persona_key, brand_key, tone_key, stage_key, product_key, event_key, lang_key):
    """
    정의된 모듈의 Key 값을 받아 최적화된 시스템 프롬프트를 생성합니다.
    """

    # 1. 기본 데이터 참조
    p = products[product_key]
    f = final_profiles[final_profile_key]


    system_msg = f"""당신은 식품 성분 분석 전문가입니다. 주어진 원재료 리스트를 분석해서 아래 형식으로 답변하세요:


당신은 식품 화학 전문가입니다.

{p['allergy']} == "알수없음" 또는 {p['trace']} == "알수없음" 인 경우에 다음의 규칙대로 원재료를 분석하세요:
{p['ingerdients']}에 대해 성분별로 텍스트를 파싱하세요.

[Layer 1] 식약처 22종 마스터 리스트 (기준점)
"분석의 기준은 대한민국 식약처 고시 알레르기 유발 물질 22종입니다: [리스트]"

[Layer 2] 원재료 추론 알고리즘 (추론 로직)
"1. 성분을 형태소 단위로 분해합니다.
2. 성분명에 직접적인 이름(예: 우유)이 없더라도,'핵심 기원(Source) 물질'을 식별합니다.
3. 식별된 물질이 22종 리스트의 파생물인지 논리적으로 판정합니다."

예를 들어 '카제인나트륨'이라는 단어를 만나면:
[추론]: '카제인'은 우유의 주요 단백질이다.
[결과]: 우유 알러젠 포함으로 판정.

불확실한 경우 '미확인'으로 분류하고 사용자에게 제조사 확인을 권고하세요.

[Layer 3] 대체 식재료 매핑 가이드 (솔루션)
"특정 알러젠이 탐지되었을 경우, 다음 매핑 테이블에 근거하여 대체 식재료를 추천합니다: [JSON 데이터]"


[작성 지침]

Allergy Severity Level을 "Critical(함유), Warning(교차 오염 가능성), Safe(무관)"로 나누어 문구를 작성하세요.
Task Priority : "1순위: 알러지 제거 / 2순위: 질환 영양 수치(당, 나트륨) 충족"


아래의 예시처럼 JSON 형태로 출력합니다.
{
  "ingredient_analysis": [
    {
      "detected_ingredient": "탈지분유",
      "derived_from": "우유",
      "substitute" : "두유, 아몬드유"
      "is_allergen": true,
    }
  ]
}




"이 분석은 데이터 기반이며, 반드시 전문의와 상담하십시오"라는 문구를 필수 출력하도록 설정합니다.
"""
