## ğŸ“‘ AI-NutriCurator ìµœì¢… í†µí•© API ëª…ì„¸ì„œ

### 1. Auth & Users (ì¸ì¦ ë° ì‚¬ìš©ì ê´€ë¦¬)

**ì„¤ëª…:** ì„œë¹„ìŠ¤ ì´ìš© ê¶Œí•œì„ í™•ì¸í•˜ê³ , AI ë¶„ì„ì˜ í•µì‹¬ ê¸°ì¤€ì´ ë˜ëŠ” ìœ ì €ì˜ ê±´ê°• ë°ì´í„°(ì§ˆë³‘, ì•Œë ˆë¥´ê¸° ë“±)ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.  

| **ê¸°ëŠ¥** | **Method** | **URL** | **ë‹´ë‹¹ íŒŒì¼** | **ì„¤ëª…** |
| --- | --- | --- | --- | --- |
| **íšŒì›ê°€ì…** | POST | `/api/v1/auth/signup` | `auth.py` | ì´ë©”ì¼, ë¹„ë°€ë²ˆí˜¸ë¡œ ê³„ì • ìƒì„± |
| **ë¡œê·¸ì¸** | POST | `/api/v1/auth/login` | `auth.py` | Access Token ë°œê¸‰ ë° ì„¸ì…˜ ì‹œì‘ |
| **ë¡œê·¸ì•„ì›ƒ** | POST | `/api/v1/auth/logout` | `auth.py` | í† í° ë¬´íš¨í™” |
| **ê±´ê°• ì •ë³´ ì €ì¥** | POST | `/api/v1/users/me/profile` | `users.py` | ìµœì´ˆ ì§ˆë³‘, ì•Œë ˆë¥´ê¸° ë“± ë°ì´í„° ì…ë ¥ |
| **ê±´ê°• ì •ë³´ ì¡°íšŒ** | GET | `/api/v1/users/me/profile` | `users.py` | **[ë§ˆì´í˜ì´ì§€ìš©]** ë³¸ì¸ ê±´ê°• ìƒíƒœ í™•ì¸ |
| **ê±´ê°• ì •ë³´ ìˆ˜ì •** | PATCH | `/api/v1/users/me/profile` | `users.py` | **[ë§ˆì´í˜ì´ì§€ìš©]** ê±´ê°• ê¸°ë¡ ìˆ˜ì • |

---

### 2. Product (ìƒí’ˆ ì •ë³´ ì¡°íšŒ)

**ì„¤ëª…:** ì»¬ë¦¬ ìŠ¤íƒ€ì¼ì˜ ë©”ì¸ í˜ì´ì§€ì™€ ìƒì„¸ í˜ì´ì§€ êµ¬ì„±ì„ ìœ„í•œ ìƒí’ˆ ë°ì´í„°ë¥¼ ì œê³µí•©ë‹ˆë‹¤.   

| **ê¸°ëŠ¥** | **Method** | **URL** | **ë‹´ë‹¹ íŒŒì¼** | **ì„¤ëª…** |
| --- | --- | --- | --- | --- |
| **ìƒí’ˆ ëª©ë¡ ì¡°íšŒ** | GET | `/api/v1/products` | `products.py` | **[ë©”ì¸/ì¹´í…Œê³ ë¦¬]** ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ (í•„í„° í¬í•¨) |
| **ìƒí’ˆ ìƒì„¸ ì¡°íšŒ** | GET | `/api/v1/products/{id}` | `products.py` | **[ìƒì„¸ í˜ì´ì§€]** ì˜ì–‘ ì„±ë¶„ ë° ìƒì„¸ ì„¤ëª… ì¡°íšŒ |

---

### 3. AI Analysis (í•µì‹¬ ë¶„ì„ ë° ì¶”ì²œ)

**ì„¤ëª…:** "ë¶„ì„ ë‹´ê¸°" í´ë¦­ ì‹œ ì‘ë™í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ ì—¬ë¶€ë¥¼ íŒë‹¨í•œ ë’¤, AIê°€ ìœ ì € ê±´ê°• ë°ì´í„°ì™€ ìƒí’ˆ ì •ë³´ë¥¼ ë¹„êµ ë¶„ì„í•˜ì—¬ ëŒ€ì²´ ìƒí’ˆê¹Œì§€ ì œì•ˆí•©ë‹ˆë‹¤.

| **ê¸°ëŠ¥** | **Method** | **URL** | **ë‹´ë‹¹ íŒŒì¼** | **ì„¤ëª…** |
| --- | --- | --- | --- | --- |
| **AI í†µí•© ë¶„ì„** | POST | `/api/v1/ai/analyze` | `ai.py` | **[Orchestrator í˜¸ì¶œ]** ìƒí’ˆ ë¶„ì„ + ëŒ€ì²´ ìƒí’ˆ 3ì¢… ì¶”ì²œ |

> **ğŸ’¡ ë¶„ì„ í”„ë¡œì„¸ìŠ¤ (Logic Flow):**
> 
> 1. í”„ë¡ íŠ¸ì—”ë“œì—ì„œ Headerì˜ `Authorization`(í† í°) í™•ì¸.
> 2. í† í°ì´ ì—†ìœ¼ë©´ -> **401 Unauthorized** ë°˜í™˜ (í”„ë¡ íŠ¸ì—ì„œ ë¡œê·¸ì¸ ìœ ë„ íŒì—… ë…¸ì¶œ).
> 3. í† í°ì´ ìˆìœ¼ë©´ -> ìœ ì € í”„ë¡œí•„ê³¼ ì„ íƒ ìƒí’ˆ IDë¥¼ AI ëª¨ë¸ì— ì „ë‹¬.
> 4. AIê°€ ë¶„ì„ ê²°ê³¼ì™€ í•¨ê»˜ ìœ ì‚¬ ì¹´í…Œê³ ë¦¬ ë‚´ 'ì•ˆì „í•œ' **ëŒ€ì²´ ìƒí’ˆ ID 3ê°œ**ë¥¼ ì‘ë‹µ.

---

### 4. Cart (ì¥ë°”êµ¬ë‹ˆ í™•ì •)

**ì„¤ëª…:** ë¶„ì„ ê³¼ì •ì„ ê±°ì¹œ í›„ ì‚¬ìš©ìê°€ ìµœì¢…ì ìœ¼ë¡œ "ë¶„ì„ ë‹´ê¸°"ë¥¼ í™•ì •í–ˆì„ ë•Œ ì²˜ë¦¬í•©ë‹ˆë‹¤.   

| **ê¸°ëŠ¥** | **Method** | **URL** | **ë‹´ë‹¹ íŒŒì¼** | **ì„¤ëª…** |
| --- | --- | --- | --- | --- |
| **ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°** | POST | `/api/v1/cart` | `cart.py` | ìµœì¢… í™•ì •ëœ ìƒí’ˆì„ DB ì¥ë°”êµ¬ë‹ˆì— ì €ì¥ |
| **ì¥ë°”êµ¬ë‹ˆ ì¡°íšŒ** | GET | `/api/v1/cart` | `cart.py` | ìƒë‹¨ ì¥ë°”êµ¬ë‹ˆ ì•„ì´ì½˜ í´ë¦­ ì‹œ ë¦¬ìŠ¤íŠ¸ í™•ì¸ |
| **ì¥ë°”êµ¬ë‹ˆ ì‚­ì œ** | DELETE | `/api/v1/cart/{cart_item_id}` | `cart.py` | ë‹´ê¸´ ìƒí’ˆ ì œì™¸ |

---

## ğŸ›  ì‚¬ìš©ì ì‹œë‚˜ë¦¬ì˜¤ ê¸°ë°˜ ë°ì´í„° íë¦„

### [Scenario: ë¶„ì„ ë‹´ê¸° í´ë¦­ ì‹œ]

1. **í”„ë¡ íŠ¸ì—”ë“œ:** `GET /api/v1/users/me/profile` ë˜ëŠ” ë¡œì»¬ í† í° ì²´í¬ë¡œ ë¡œê·¸ì¸ ì—¬ë¶€ í™•ì¸.
2. **ë¡œê·¸ì¸ X:** "ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤" íŒì—… -> ë¡œê·¸ì¸ í˜ì´ì§€ ì´ë™.
3. **ë¡œê·¸ì¸ O:** `POST /api/v1/ai/analyze` í˜¸ì¶œ (Body: `product_id`).   
4. **ë°±ì—”ë“œ(AI):** ìœ ì € ê±´ê°• ì •ë³´(ê³ í˜ˆì•• ë“±)ì™€ ìƒí’ˆ ì„±ë¶„ ë¹„êµ.
    - **ì‘ë‹µ ì˜ˆì‹œ:** `{"status": "warning", "msg": "ë‚˜íŠ¸ë¥¨ì´ ë†’ìŠµë‹ˆë‹¤", "alternatives": [ID_A, ID_B, ID_C]}`
5. **í”„ë¡ íŠ¸ì—”ë“œ:** ëŒ€ì²´ ìƒí’ˆ í´ë¦­ ì‹œ `GET /api/v1/products/{id}`ë¡œ ìƒì„¸ í˜ì´ì§€ ì´ë™.
6. **ì‚¬ìš©ì:** ìƒì„¸ í˜ì´ì§€ì—ì„œ ë‹¤ì‹œ **[ë¶„ì„ ë‹´ê¸°]** -> ìµœì¢…ì ìœ¼ë¡œ `POST /api/v1/cart` í˜¸ì¶œí•˜ì—¬ ì¥ë°”êµ¬ë‹ˆì— ì™!

---

### ğŸ’¡ êµ¬ì¡° ì„¤ê³„ í•µì‹¬ ìš”ì•½

1. **ê´€ì‹¬ì‚¬ ë¶„ë¦¬:** * `/users/me/profile`ì€ ë‹¨ìˆœíˆ ì •ë³´ë¥¼ **ì €ì¥**ë§Œ í•©ë‹ˆë‹¤.      
    - ì‹¤ì œ **ë¶„ì„**ì€ `/ai/cart-check`ë¥¼ í˜¸ì¶œí•  ë•Œ ë‚´ë¶€ì˜ `User Agent`ê°€ ì €ì¥ëœ ì •ë³´ë¥¼ êº¼ë‚´ì™€ì„œ ìˆ˜í–‰í•©ë‹ˆë‹¤.
2. **AI ì§€íœ˜ì(Orchestrator)ì˜ ìœ„ì¹˜:** * `ai.py` ê²½ë¡œë¡œ ë“¤ì–´ì˜¤ëŠ” ìš”ì²­ë§Œ `ai/orchestrator/runner.py`ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
    - ì¼ë°˜ì ì¸ ìƒí’ˆ ëª©ë¡(`products.py`) ì¡°íšŒ ì‹œì—ëŠ” AIê°€ ê°œì…í•˜ì§€ ì•Šì•„ ì„œë²„ ë¶€í•˜ë¥¼ ì¤„ì…ë‹ˆë‹¤.
3. **ë°ì´í„°ì˜ íë¦„:**
    - `api/routes/`ì—ì„œ ìš”ì²­ ìˆ˜ì‹ 
    - â” `domain/services/`ì—ì„œ ë°ì´í„° ê°€ê³µ(ì‹¤ì œ ì„œë¹„ìŠ¤ ë¡œì§ ì‹¤í–‰ ì½”ë“œ)
    - â” `infra/db/repositories/`ì—ì„œ DB ì €ì¥/ì¡°íšŒ ì—­í• ì„ ìˆ˜í–‰í•˜ëŠ” ê³³.

## ğŸ¤– Orche ë° Agent íë¦„ (LLM ì—†ì´ ë¶„ê¸° / Toolì€ Agentê°€ ì§ì ‘ ì‹¤í–‰)

---

### ğŸš€ AI ì—ì´ì „íŠ¸ ì „ì²´ ë°ì´í„° íŒŒì´í”„ë¼ì¸ (The Full-Stack Flow)

### **1ë‹¨ê³„: ìš”ì²­ ì ‘ìˆ˜ ë° ê³µìš© ë©”ëª¨ì¥(State) ìƒì„±**

- **íŒŒì¼:** `api/routes/ai.py` â†’ `ai/orchestrator/runner.py`
- **íë¦„:** í”„ë¡ íŠ¸ì—”ë“œ ìš”ì²­ ìˆ˜ì‹  í›„, ë¹ˆ `OverallState`(í™”ì´íŠ¸ë³´ë“œ)ë¥¼ ìƒì„±í•˜ê³  `user_id`, `product_id`, `request_type` ê°™ì€ ê¸°ë³¸ê°’ì„ ì±„ìš´ ë’¤ Orchestratorë¡œ ë„˜ê¹ë‹ˆë‹¤.

---

### **2ë‹¨ê³„: Orchestratorê°€ ì‹¤í–‰ ìˆœì„œ/ë¶„ê¸° ê²°ì • (LLM ì—†ìŒ)**

- **íŒŒì¼:** `ai/orchestrator/policy.py` (í•„ìš”ì‹œ `ai/orchestrator/graph.py`)
- **ë¡œì§:** OrchestratorëŠ” LLMì²˜ëŸ¼ â€œìƒê°í•´ì„œ ë„êµ¬ë¥¼ ê³ ë¥´ëŠ”â€ ì—­í• ì„ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    
    ëŒ€ì‹  **state ê°’(í”Œë˜ê·¸/ê²°ê³¼)** ì„ ë³´ê³  **if/else ê·œì¹™**ìœ¼ë¡œ ì–´ë–¤ Agentë¥¼ ì–´ë–¤ ìˆœì„œë¡œ ëŒë¦´ì§€ ê²°ì •í•©ë‹ˆë‹¤.
    

ì˜ˆì‹œ)

- `user_agent` â†’ `chat_core` ì‹¤í–‰
- `state.warning == True` ì´ë©´ â†’ `reco_agent` â†’ `substitution_agent`
- ë§ˆì§€ë§‰ì€ â†’ `composer_agent`

---

### **3ë‹¨ê³„: Agentê°€ Toolì„ ì§ì ‘ importí•´ì„œ ì‹¤í–‰ (Planning ì—†ìŒ / ì‹¤í–‰ë§Œ)**

- **íŒŒì¼:** `ai/agents/*.py` (ì˜ˆ: `ai/agents/user_agent.py`)
- **ë¡œì§:** ì—ì´ì „íŠ¸ëŠ” ì´ì œ â€œLLMì´ ë„êµ¬ ëª©ë¡ ë³´ê³  ì„ íƒâ€í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    
    í•„ìš”í•œ tool í•¨ìˆ˜ë¥¼ **ê·¸ëƒ¥ importí•´ì„œ ì§ì ‘ í˜¸ì¶œ**í•©ë‹ˆë‹¤.
    

ì˜ˆì‹œ ëŠë‚Œ)

- `from ai.tools.user_tools import get_user_profile`
- `profile = get_user_profile(user_id)`
- `state.final_profile = profile`

---

### **4ë‹¨ê³„: Tool â†’ Service â†’ Repoë¡œ ë‚´ë ¤ê°€ì„œ ë°ì´í„° ì¡°íšŒ/ê°€ê³µ**

- **íŒŒì¼:** `ai/tools/*.py` â†’ `domain/services/*.py` â†’ `infra/db/repositories/*.py`
- **ë¡œì§:**
    1. **Repo**ê°€ DBì˜ Raw ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
    2. **Service**ê°€ íŒì •/ì¶”ì²œì— ë§ê²Œ ê°€ê³µí•©ë‹ˆë‹¤.
    3. **Tool**ì€ Serviceë¥¼ í˜¸ì¶œí•´ì„œ **Agentê°€ ì“°ê¸° ì‰¬ìš´ í˜•íƒœ**ë¡œ ëŒë ¤ì¤ë‹ˆë‹¤.

> âœ… ì—¬ê¸°ì„œ Toolì€ â€œLLM toolâ€ì´ ì•„ë‹ˆë¼ **Agent ê³µìš© í•¨ìˆ˜**ë¼ê³  ë³´ë©´ ë¨.
> 

---

### **5ë‹¨ê³„: ë©”ëª¨ì¥(State) ì—…ë°ì´íŠ¸**

- **íŒŒì¼:** `ai/agents/*.py` â” `ai/state/schema.py`
- **ë¡œì§:** Agentê°€ tool ê²°ê³¼ë¥¼ ë°›ì•„ì„œ í™”ì´íŠ¸ë³´ë“œì˜ í•´ë‹¹ ì¹¸(ì˜ˆ: `reco_candidates`, `warning`, `substitutions`)ì— ê¸°ë¡í•©ë‹ˆë‹¤.
    
    ê·¸ë¦¬ê³  íë¦„ ì œì–´ìš©ìœ¼ë¡œ `next_step` ê°™ì€ ê°’ë„ í•¨ê»˜ ê°±ì‹ í•©ë‹ˆë‹¤.
    

---

### ğŸ“Š ì—ì´ì „íŠ¸ë³„ "íŒŒì¼ ì´ë™" ì§€ë„

| **ì—ì´ì „íŠ¸** | **ì‚¬ìš© ë„êµ¬ (ai/tools/)** | **ì‹¤ì œ ë¡œì§ (domain/services/)** | **ìµœì¢… ê¸°ë¡ ì¹¸ -ì˜ˆì‹œ (ai/state/schema.py)** |
| --- | --- | --- | --- |
| **User Agent** | `user_tools.py` | `user_service.py` | `final_profile` (flags, allergy_list í¬í•¨) |
| **Chat Core Agent** | `rule_tools.py`, `product_tools.py` | `rule_engine.py`, `product_service.py` | `ingredient_analysis`, `warning`, `next_step` |
| **Reco Agent** | `reco_tools.py` | `reco_service.py` | `reco_candidates`, `reco_user_context` |
| **Substitution Agent** | `substitution_tools.py` | `substitution_service.py` | `substitutions`, `sub_summary` |
| **Cart Agent (ì˜µì…˜)** | `cart_tools.py` | `cart_service.py` | `cart_scan_result` |
| **Composer Agent (LLM)** | `infra/llm/client.py` | (í•„ìš”ì‹œ service ë„ì›€) | `final_answer` |

---

### âœ… ì „ì²´ íë¦„

1. Orchestratorê°€ ì´ˆê¸° stateë¥¼ ì½ê³   agent ì‹¤í–‰ ìˆœì„œ ê²°ì •    
2. Agentê°€ ë³¸ì¸ stateë¥¼ ì½ê³  toolì„ import í•´ì„œ í˜¸ì¶œ  
3. Toolì´ service í˜¸ì¶œ
4. Serviceê°€ repoë¡œ DB ì¡°íšŒ 
5. ê²°ê³¼ê°€ tool â†’ agentë¡œ ëŒì•„ì˜´
6. Agentê°€ stateì— ê¸°ë¡  
7. Orchestratorê°€ state ê²°ê³¼ ë³´ê³  ë‹¤ìŒ agent ë¶„ê¸°    

### ğŸ“ ê°œë°œ ìˆœì„œ (ì¶”ì²œ)

ê°œë°œì€ **ì—­ìˆœ**ìœ¼ë¡œ ì˜¬ë¼ê°€ëŠ” ê²Œ ê°€ì¥ í¸í•©ë‹ˆë‹¤.

1. **Repo:** DBì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì½”ë“œ ì‘ì„±
2. **Service:** ë°ì´í„°ë¥¼ íŒì •/ì¶”ì²œìš©ìœ¼ë¡œ ê°€ê³µí•˜ëŠ” í•¨ìˆ˜ ì‘ì„±(agentê°€ ì…ë ¥ ë°›ì•„ì•¼ í•  ê°’ì„ ìˆ˜í–‰í•˜ëŠ” ì½”ë“œ)
3. **Tool:** ê·¸ í•¨ìˆ˜ë¥¼ ì—ì´ì „íŠ¸ê°€ ì“°ê¸° ì‰½ê²Œ  í•¨ìˆ˜ë¡œ í¬ì¥ â†’ agentê°€ import  
4. **Agent:** tool í˜¸ì¶œ â†’ stateì— ê¸°ë¡í•˜ëŠ” ë¡œì§ ì‘ì„±
5. **Orchestrator policy:** state ê²°ê³¼ê°’ ê¸°ë°˜ ë¶„ê¸° ê·œì¹™(if/else) ì‘ì„±
6. **Composer(LLM):** ìµœì¢… ë¬¸ì¥/ì¹´ë“œ ìƒì„±(í†¤/í¬ë§·) ë¶™ì´ê¸°